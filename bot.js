require('dotenv').config();
const { Bot } = require('@maxhub/max-bot-api');

const bot = new Bot(process.env.BOT_TOKEN);

const categories = {
    'гастрономия': {
        title: 'Гастрономия Омска',
        places: [
            'Манилов — десерты и кофе (ул. Ленина, 2)',
            'Зебра — сибирская кухня (набережная)',
            'Колчак — загутай у реки (ул. Декабристов)',
            'Сибирское подворье — медвежатина (ул. 5 Декабря)',
            'Суши Бамбуши — роллы (ул. Маяковского, 101)',
            'Лара — домашние торты (ул. Красный Путь)'
        ],
        map: 'https://yandex.ru/maps/?text=кафе+рестораны+Омск&z=12'
    },
    'достопримечательности': {
        title: 'Достопримечательности Омска',
        places: [
            'Омская крепость — XVIII век, музей',
            'Успенский собор — золотые купола',
            'Тарские ворота — вход в Сибирь',
            'Любинский проспект — пешеходная зона',
            'Музей Врубеля — шедевры искусства',
            'Пожарная каланча — панорама города',
            'Памятник Степанычу — омский юмор'
        ],
        map: 'https://yandex.ru/maps/?text=достопримечательности+Омск&z=13'
    },
    'парки': {
        title: 'Парки и природа',
        places: [
            'Парк 30-летия ВЛКСМ — аттракционы',
            'Птичья гавань — экотропы',
            'Парк Победы — мемориал',
            'Зелёный остров — прогулки',
            'Парк Вокруг света — канатные трассы'
        ],
        map: 'https://yandex.ru/maps/?text=парки+Омск&z=12'
    },
    'развлечения': {
        title: 'Развлечения',
        places: [
            'Театр драмы — классика',
            'Кино «Космос» — IMAX',
            'Квест «Побег» — 5 сценариев',
            'Боулинг «Космос» — 12 дорожек',
            'Театр Арлекин — куклы'
        ],
        map: 'https://yandex.ru/maps/?text=театры+кино+квесты+Омск&z=12'
    },
    'шопинг': {
        title: 'Шопинг',
        places: [
            'ТЦ «Мега» — 120 магазинов',
            'ТЦ «Континент» — одежда',
            'ТЦ «Каскад» — электроника',
            'Рынок «Левобережный» — продукты'
        ],
        map: 'https://yandex.ru/maps/?text=ТЦ+рынки+Омск&z=12'
    },
    'ночная жизнь': {
        title: 'Ночная жизнь',
        places: [
            'Клуб «Ангар» — танцы до утра',
            'Бар «Сибирь» — крафтовое пиво',
            'Караоке «Голос» — 5000 песен',
            'Клуб «Опера» — шоу-программа'
        ],
        map: 'https://yandex.ru/maps/?text=бары+клубы+Омск&z=13'
    },
    'для детей': {
        title: 'Для детей',
        places: [
            'Омский зоопарк — шоу и тигры',
            'Аквапарк «АкваРИО» — горки',
            'Театр Арлекин — сказки',
            'КидБург — профессии'
        ],
        map: 'https://yandex.ru/maps/?text=зоопарк+аквапарк+дети+Омск&z=12'
    }
};

function formatCategory(key) {
    const cat = categories[key];
    let msg = `${cat.title}\n\nЗдесь вы найдёте:\n\n`;
    cat.places.forEach(p => { msg += `   ${p}\n`; });
    msg += `\nКарта всех мест: [Открыть в Яндекс.Картах](${cat.map})\n\n`;
    msg += `Доступно: Гастрономия • Достопримечательности • Парки • Развлечения • Шопинг • Ночная жизнь • Для детей`;
    return msg;
}

bot.command('start', async (ctx) => {
    await ctx.reply(
        `Омск: Гид по городу\n\n` +
        `Привет! Я помогу вам открыть для себя лучшие места нашего города.\n\n` +
        `Выберите категорию:\n\n` +
        `Гастрономия\n` +
        `Достопримечательности\n` +
        `Парки\n` +
        `Развлечения\n` +
        `Шопинг\n` +
        `Ночная жизнь\n` +
        `Для детей\n\n` +
        `Либо напишите название — получите карту с местом.\n\n`
    );
});

function findCategory(text) {
    const lowerText = text.toLowerCase().trim();

    if (lowerText === 'гастрономия') return 'гастрономия';
    if (lowerText === 'достопримечательности') return 'достопримечательности';
    if (lowerText === 'парки') return 'парки';
    if (lowerText === 'развлечения') return 'развлечения';
    if (lowerText === 'шопинг') return 'шопинг';
    if (lowerText === 'ночная жизнь') return 'ночная жизнь';
    if (lowerText === 'для детей') return 'для детей';

    return null;
}

bot.on('message_created', async (ctx) => {
    const query = ctx.message.body?.text?.trim();
    if (!query) return;

    const catKey = findCategory(query);
    if (catKey) {
        await ctx.reply(formatCategory(catKey));
    } else {

        const encodedQuery = query.replace(/\s+/g, '+');
        const mapUrl = `https://yandex.ru/maps/?text=${encodedQuery}+Омск&z=12`;
        await ctx.reply(
            `Результаты по запросу "${query}":\n\n` +
            `Я нашёл места в Омске. Откройте карту для деталей, маршрутов и отзывов:\n\n` +
            `[Открыть в Яндекс.Картах](${mapUrl})\n\n` +
            `Доступно: Гастрономия • Достопримечательности • Парки • Развлечения • Шопинг • Ночная жизнь • Для детей`
        );
    }
});

bot.catch(err => console.error('Ошибка:', err));
console.log('Омск: Гид по городу — запущен.');
bot.start();